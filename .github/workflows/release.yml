name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        working-directory: ./web
        run: bun install --frozen-lockfile

      - name: Build frontend
        working-directory: ./web
        run: bun run build

      - name: Copy frontend dist
        run: |
          rm -rf cmd/server/dist
          cp -r web/dist cmd/server/

      - name: Build Linux amd64
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o relay ./cmd/server
          chmod +x relay
          tar -czvf relay-linux-amd64.tar.gz relay
          rm relay

      - name: Build Linux arm64
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o relay ./cmd/server
          chmod +x relay
          tar -czvf relay-linux-arm64.tar.gz relay
          rm relay

      - name: Build macOS amd64
        run: |
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o relay ./cmd/server
          chmod +x relay
          tar -czvf relay-darwin-amd64.tar.gz relay
          rm relay

      - name: Build macOS arm64
        run: |
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o relay ./cmd/server
          chmod +x relay
          tar -czvf relay-darwin-arm64.tar.gz relay
          rm relay

      - name: Build Windows amd64
        run: |
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o relay.exe ./cmd/server
          zip relay-windows-amd64.zip relay.exe
          rm relay.exe

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            relay-linux-amd64.tar.gz
            relay-linux-arm64.tar.gz
            relay-darwin-amd64.tar.gz
            relay-darwin-arm64.tar.gz
            relay-windows-amd64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
